name: Update README with Latest Activity

on:
    schedule:
        # Runs every 6 hours
        - cron: "0 */6 * * *"
    workflow_dispatch:
    push:
        branches:
            - master

jobs:
    update-readme:
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Fetch latest activity and update README
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const fs = require('fs');
                      const core = require('@actions/core');

                      const org = 'ESP-Corevia';
                      const repos = ['CoreApp', 'corevia_mobile', 'rag-communication-service', 'Document', 'T-LAW-901'];

                      const activity = {};

                      async function fetchRepoActivity(repo) {
                        try {
                          // Get latest issues (including closed)
                          const { data: issues } = await github.rest.issues.listForRepo({
                            owner: org,
                            repo,
                            state: 'all',
                            sort: 'created',
                            direction: 'desc',
                            per_page: 10
                          });

                          const latestIssue = issues.find(i => !i.pull_request) || null;

                          // Latest PR
                          const { data: prs } = await github.rest.pulls.list({
                            owner: org,
                            repo,
                            state: 'all',
                            sort: 'created',
                            direction: 'desc',
                            per_page: 1
                          });

                          // Repo metadata
                          const { data: repoData } = await github.rest.repos.get({
                            owner: org,
                            repo
                          });

                          activity[repo] = {
                            latestIssue: latestIssue
                              ? {
                                  number: latestIssue.number,
                                  title:
                                    latestIssue.title.length > 50
                                      ? latestIssue.title.substring(0, 50) + '...'
                                      : latestIssue.title,
                                  url: latestIssue.html_url
                                }
                              : null,
                            latestPR: prs[0]
                              ? {
                                  number: prs[0].number,
                                  title:
                                    prs[0].title.length > 50
                                      ? prs[0].title.substring(0, 50) + '...'
                                      : prs[0].title,
                                  url: prs[0].html_url
                                }
                              : null,
                            openIssues: repoData.open_issues_count,
                            description: repoData.description
                          };

                          console.log(`‚úÖ Fetched activity for ${repo}`);
                        } catch (error) {
                          console.log(`‚ö†Ô∏è Error fetching ${repo}: ${error.message}`);
                          activity[repo] = {
                            latestIssue: null,
                            latestPR: null,
                            openIssues: 0,
                            description: null
                          };
                        }
                      }

                      // Fetch all repos in parallel
                      await Promise.all(repos.map(fetchRepoActivity));

                      // Get total public repo count
                      const orgRepos = await github.paginate(github.rest.repos.listForOrg, {
                        org,
                        type: 'public',
                        per_page: 100
                      });
                      const totalRepos = orgRepos.length;

                      const readmePath = '.github/profile/README.md';
                      let readme = fs.readFileSync(readmePath, 'utf8');

                      // Helper to replace between markers
                      function replaceBetween(content, marker, replacement) {
                        const start = `<!-- ${marker} -->`;
                        const end = `<!-- /${marker} -->`;
                        const regex = new RegExp(`${start}[\\s\\S]*?${end}`, 'm');
                        return content.replace(regex, `${start}${replacement}${end}`);
                      }

                      // --- CoreApp markers ---
                      if (activity.CoreApp?.latestIssue) {
                        const issue = activity.CoreApp.latestIssue;
                        const link = `[#${issue.number} - ${issue.title}](${issue.url})`;
                        readme = replaceBetween(readme, 'COREAPP_LATEST_ISSUE', link);
                      } else {
                        readme = replaceBetween(readme, 'COREAPP_LATEST_ISSUE', '_No issues yet_');
                      }

                      if (activity.CoreApp?.latestPR) {
                        const pr = activity.CoreApp.latestPR;
                        const link = `[#${pr.number} - ${pr.title}](${pr.url})`;
                        readme = replaceBetween(readme, 'COREAPP_LATEST_PR', link);
                      } else {
                        readme = replaceBetween(readme, 'COREAPP_LATEST_PR', '_No PRs yet_');
                      }

                      // --- corevia_mobile markers ---
                      if (activity.corevia_mobile?.latestIssue) {
                        const issue = activity.corevia_mobile.latestIssue;
                        const link = `[#${issue.number} - ${issue.title}](${issue.url})`;
                        readme = replaceBetween(readme, 'MOBILE_LATEST_ISSUE', link);
                      } else {
                        readme = replaceBetween(readme, 'MOBILE_LATEST_ISSUE', '_No issues yet_');
                      }

                      if (typeof activity.corevia_mobile?.openIssues === 'number') {
                        const count = activity.corevia_mobile.openIssues;
                        readme = replaceBetween(readme, 'MOBILE_OPEN_ISSUES', `**${count}**`);
                      }

                      // --- Document markers ---
                      if (activity.Document?.latestIssue) {
                        const issue = activity.Document.latestIssue;
                        const link = `[#${issue.number} - ${issue.title}](${issue.url})`;
                        readme = replaceBetween(readme, 'DOC_LATEST_ISSUE', link);
                      } else {
                        readme = replaceBetween(readme, 'DOC_LATEST_ISSUE', '_No issues yet_');
                      }

                      // Update total repos badge and stats table
                      readme = readme.replace(
                        /Repositories-\d+-blue/g,
                        `Repositories-${totalRepos}-blue`
                      );

                      readme = readme.replace(
                        /(\| üì¶ Total Repositories\s+\|\s+)\d+/,
                        `$1${totalRepos}`
                      );

                      // Update LAST_UPDATED comment (YYYY-MM-DD)
                      const now = new Date().toISOString().split('T')[0];
                      if (readme.includes('<!-- LAST_UPDATED:')) {
                        readme = readme.replace(
                          /<!-- LAST_UPDATED:[^>]+ -->/,
                          `<!-- LAST_UPDATED:${now} -->`
                        );
                      }

                      fs.writeFileSync(readmePath, readme);
                      console.log('üìù README updated successfully!');

                      core.setOutput('updated', 'true');
                      core.setOutput('activity', JSON.stringify(activity, null, 2));

            - name: Commit and push changes
              run: |
                  git config --local user.email "github-actions[bot]@users.noreply.github.com"
                  git config --local user.name "github-actions[bot]"
                  git add -A
                  if git diff --quiet && git diff --staged --quiet; then
                    echo "No changes to commit."
                  else
                    git commit -m "ü§ñ Auto-update README with latest activity [skip ci]"
                    git push
                  fi
